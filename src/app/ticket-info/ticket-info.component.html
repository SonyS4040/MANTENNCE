@if (!isEditing()) {
  <div class="detail-section">
    <div class="section-header">
      <h3>معلومات العميل والمهندس</h3>
      <button (click)="toggleEdit()" class="edit-btn">تعديل</button>
    </div>
    <div class="info-grid">
      <div class="info-item"><strong>اسم العميل:</strong><p>{{ ticket.customer_name }}</p></div>
      <div class="info-item"><strong>رقم الهاتف:</strong><p>{{ ticket.customer_phone }}</p></div>
      <div class="info-item"><strong>المهندس المسؤول:</strong><p>{{ ticket.engineers?.name || 'لم يتم التعيين بعد' }}</p></div>
      <div class="info-item full-width"><strong>عنوان المنشأة:</strong><p>{{ ticket.customer_address }}</p></div>
    </div>
  </div>

  <div class="detail-section">
    <h3>معلومات الجهاز والعطل</h3>
    <div class="info-grid">
      <div class="info-item"><strong>نوع الجهاز:</strong><p>{{ ticket.device_type }}</p></div>
      <div class="info-item"><strong>الرقم التسلسلي:</strong><p>{{ ticket.serial_number || 'غير متوفر' }}</p></div>
      <div class="info-item full-width"><strong>وصف العطل:</strong><p class="description">{{ ticket.fault_description }}</p></div>
      <div class="info-item"><strong>تاريخ الإنشاء:</strong><p>{{ ticket.created_at | date:'yyyy/MM/dd hh:mm a' }}</p></div>
    </div>
  </div>
} @else {
  <form [formGroup]="ticketForm" (ngSubmit)="saveChanges()" class="edit-form">
    <div class="detail-section">
      <h3>تعديل معلومات العميل</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="customer_name">اسم العميل</label>
          <input id="customer_name" type="text" formControlName="customer_name">
        </div>
        <div class="form-group">
          <label for="customer_phone">رقم الهاتف</label>
          <input id="customer_phone" type="text" formControlName="customer_phone">
        </div>
        <div class="form-group full-width">
          <label for="customer_address">عنوان المنشأة</label>
          <textarea id="customer_address" formControlName="customer_address" rows="3"></textarea>
        </div>
      </div>
    </div>

    <div class="detail-section">
      <h3>تعديل معلومات الجهاز والعطل</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="device_type">نوع الجهاز</label>
          <input id="device_type" type="text" formControlName="device_type">
        </div>
        <div class="form-group">
          <label for="serial_number">الرقم التسلسلي</label>
          <input id="serial_number" type="text" formControlName="serial_number">
        </div>
        <div class="form-group full-width">
          <label for="fault_description">وصف العطل</label>
          <textarea id="fault_description" formControlName="fault_description" rows="5"></textarea>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="save-btn" [disabled]="isSaving() || ticketForm.invalid">
        @if(isSaving()) { <span>جاري الحفظ...</span> } @else { <span>حفظ التعديلات</span> }
      </button>
      <button type="button" (click)="toggleEdit()" class="cancel-btn">إلغاء</button>
    </div>
  </form>
}

@if (ticket.attachment_url) {
  <div class="detail-section">
    <h3>المرفقات</h3>
    <a [href]="ticket.attachment_url" target="_blank" rel="noopener noreferrer" class="attachment-link">عرض المرفق</a>
  </div>
}

@if (ticket.before_repair_video_url) {
  <div class="detail-section">
    <h3>فيديو قبل الإصلاح</h3>
    <video controls width="100%">
      <source [src]="ticket.before_repair_video_url" type="video/mp4">
      متصفحك لا يدعم عرض الفيديو.
    </video>
  </div>
}

@if (ticket.repair_video_url) {
  <div class="detail-section">
    <h3>فيديو بعد الإصلاح</h3>
    <video controls width="100%">
      <source [src]="ticket.repair_video_url" type="video/mp4">
      متصفحك لا يدعم عرض الفيديو.
    </video>
  </div>
}