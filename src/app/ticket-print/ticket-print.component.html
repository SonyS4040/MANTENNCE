<div class="print-page-container">
  <div class="page-actions no-print">
    <a [routerLink]="['/tickets', ticket()?.id]" class="back-link">&larr; العودة إلى تفاصيل العطل</a>
    <button (click)="printPage()" class="print-btn">طباعة</button>
  </div>

  @if (isLoading) {
    <p class="loading-message">جاري تجهيز التقرير للطباعة...</p>
  } @else if (error) {
    <div class="error-message">{{ error }}</div>
  } @else if (ticket()) {
    <div class="print-content" id="print-section">
      <header class="report-header">
        <div class="logo-container">
          <h1 class="company-name">أواسيس فارما جروب</h1>
          <p class="company-subtitle">قسم الصيانة والدعم الفني</p>
        </div>
        <h2 class="report-title">تقرير صيانة</h2>
      </header>

      <section class="info-section">
        <div class="info-box">
          <p><strong>الرقم المرجعي:</strong> {{ ticket()!.ticket_ref }}</p>
          <p><strong>تاريخ الإنشاء:</strong> {{ ticket()!.created_at | date:'yyyy/MM/dd' }}</p>
        </div>
        <div class="info-box">
          <p><strong>حالة العطل:</strong> {{ ticket()!.status }}</p>
          <p><strong>الأولوية:</strong> {{ ticket()!.priority }}</p>
        </div>
         <div class="info-box">
          <p><strong>تاريخ الزيارة:</strong> {{ ticket()!.visit_date | date:'yyyy/MM/dd' }}</p>
          <p><strong>حالة الضمان:</strong> {{ ticket()!.warranty_status }}</p>
        </div>
      </section>

      <section class="details-section">
        <h3>1. بيانات العميل</h3>
        <div class="grid-container">
          <p><strong>اسم العميل:</strong> {{ ticket()!.customer_name }}</p>
          <p><strong>رقم الهاتف:</strong> {{ ticket()!.customer_phone }}</p>
          <p class="full-span"><strong>عنوان المنشأة:</strong> {{ ticket()!.customer_address }}</p>
        </div>
      </section>

      <section class="details-section">
        <h3>2. بيانات الجهاز</h3>
        <div class="grid-container">
          <p><strong>نوع الجهاز:</strong> {{ ticket()!.device_type }}</p>
          <p><strong>الرقم التسلسلي:</strong> {{ ticket()!.serial_number || 'غير متوفر' }}</p>
        </div>
      </section>
      
      <section class="details-section">
        <h3>3. وصف العطل (حسب بلاغ العميل)</h3>
        <p class="notes">{{ ticket()!.fault_description }}</p>
      </section>

      <section class="details-section">
        <h3>4. التقرير الفني</h3>
        <p><strong>المهندس المسؤول:</strong> {{ ticket()!.engineers?.name || 'لم يتم التعيين' }}</p>
        
        <h4>أ. ملاحظات الفحص الفني المبدئي:</h4>
        <p class="notes">{{ ticket()!.technical_inspection_notes || 'لا توجد ملاحظات.' }}</p>

        <h4>ب. الإجراءات التي تمت وقطع الغيار المستخدمة:</h4>
        <p class="notes">{{ ticket()!.repair_notes || 'لا توجد ملاحظات.' }}</p>

        <h4>ج. ملاحظات تسليم الجهاز للعميل:</h4>
        <p class="notes">{{ ticket()!.handover_notes || 'لا توجد ملاحظات.' }}</p>
      </section>

      <section class="details-section">
        <h3>5. تفاصيل التكاليف</h3>
        @if (ticket()!.maintenance_costs && ticket()!.maintenance_costs.length > 0) {
          <table class="costs-table">
            <thead>
              <tr>
                <th>الوصف</th>
                <th>الكمية</th>
                <th>سعر الوحدة</th>
                <th>الإجمالي</th>
              </tr>
            </thead>
            <tbody>
              @for (item of ticket()!.maintenance_costs; track item.id) {
                <tr>
                  <td>{{ item.description }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ item.unit_price | currency:'EGP ' }}</td>
                  <td>{{ (item.quantity * item.unit_price) | currency:'EGP ' }}</td>
                </tr>
              }
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3">الإجمالي الكلي</td>
                <td>{{ totalCost() | currency:'EGP ' }}</td>
              </tr>
            </tfoot>
          </table>
        } @else {
          <p class="notes">لا توجد تكاليف مسجلة لهذا العطل.</p>
        }
      </section>

      <footer class="report-footer">
        <div class="signature-box">
          <p><strong>توقيع الفني المسؤول</strong></p>
          <div class="signature-line"></div>
        </div>
        <div class="signature-box">
          <p><strong>توقيع العميل (عند الاستلام)</strong></p>
          <div class="signature-line"></div>
        </div>
      </footer>
    </div>
  }
</div>